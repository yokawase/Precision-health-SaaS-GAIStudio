<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Precision Health Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#0f172a',
              accent: '#2563eb',
              success: '#10b981',
              warning: '#f59e0b',
              danger: '#ef4444',
              bg: '#f8fafc',
            }
          }
        }
      }
    </script>
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        @keyframes slide-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-down { animation: slide-down 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        // Add ?external=react,react-dom to prevent duplicate React instances
        import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine, Legend } from 'https://esm.sh/recharts@2.12.0?external=react,react-dom';
        import { 
            User, Activity, FileText, Calculator, DollarSign, TrendingUp, AlertTriangle, 
            CheckCircle, Share2, Copy, HeartPulse, Download, Thermometer, AlertCircle, 
            ShieldCheck, XCircle, Heart, Edit3, Stethoscope, BarChart2 
        } from 'https://esm.sh/lucide-react@0.330.0?external=react';

        // --- CONSTANTS ---
        const HOURLY_WAGE = 1300;
        const ANNUAL_HOURS = 2080;
        const RETIREMENT_AGE = 65;

        const CONST_QX_MALE = [0.00074,0.00025,0.00018,0.00013,0.0001,9e-05,8e-05,8e-05,7e-05,7e-05,7e-05,8e-05,0.00011,0.00017,0.00023,0.00031,0.00039,0.00047,0.00054,0.00062,0.00068,0.00074,0.00079,0.00082,0.00085,0.00087,0.00089,0.00091,0.00093,0.00096,0.001,0.00105,0.0011,0.00116,0.00123,0.00132,0.00142,0.00154,0.00169,0.00185,0.00204,0.00224,0.00247,0.00273,0.00303,0.00336,0.00374,0.00417,0.00463,0.00514,0.0057,0.00631,0.00699,0.00774,0.00856,0.00946,0.01047,0.01157,0.01279,0.01412,0.01559,0.01721,0.01898,0.02092,0.02302,0.02531,0.02778,0.03046,0.03335,0.03647,0.03985,0.0435,0.04743,0.05168,0.05625,0.06118,0.06648,0.07217,0.07829,0.08485,0.09189,0.09943,0.1075,0.11613,0.12535,0.13519,0.14567,0.15683,0.16868,0.18125,0.19456,0.20862,0.22345,0.23906,0.25545,0.27263,0.2906,0.30935,0.32887,0.34914,0.37012,0.39179,0.41408,0.43695,0.46033,1.0];
        const CONST_EX_MALE = [81.09,80.24,79.26,78.27,77.28,76.29,75.30,74.30,73.31,72.31,71.32,70.33,69.33,68.34,67.35,66.36,65.37,64.38,63.40,62.42,61.44,60.47,59.49,58.52,57.55,56.58,55.60,54.63,53.65,52.68,51.71,50.73,49.76,48.79,47.82,46.85,45.88,44.92,43.95,42.99,42.03,41.07,40.11,39.16,38.21,37.26,36.31,35.37,34.43,33.49,32.57,31.64,30.72,29.81,28.91,28.01,27.12,26.23,25.36,24.49,23.63,22.78,21.94,21.10,20.28,19.47,18.67,17.88,17.11,16.35,15.60,14.86,14.14,13.44,12.75,12.08,11.43,10.79,10.16,9.55,8.96,8.39,7.84,7.31,6.80,6.31,5.85,5.41,5.01,4.62,4.27,3.95,3.63,3.33,3.05,2.78,2.53,2.30,2.08,1.88,1.69,1.52,1.36,1.22,1.09,0.97];
        const CONST_QX_FEMALE = [0.00067,0.00025,0.00019,0.00014,0.0001,8e-05,7e-05,7e-05,6e-05,6e-05,6e-05,6e-05,7e-05,9e-05,0.00012,0.00015,0.00018,0.00022,0.00026,0.00029,0.00032,0.00035,0.00037,0.00039,0.00041,0.00042,0.00043,0.00045,0.00047,0.00050,0.00053,0.00057,0.00061,0.00066,0.00071,0.00076,0.00082,0.00089,0.00096,0.00104,0.00113,0.00124,0.00135,0.00148,0.00162,0.00179,0.00197,0.00217,0.0024,0.00265,0.00293,0.00324,0.00359,0.00398,0.00441,0.00488,0.00541,0.00599,0.00664,0.00736,0.00815,0.00901,0.00997,0.01102,0.01217,0.01344,0.01482,0.01634,0.018,0.01981,0.0218,0.02397,0.02635,0.02896,0.03182,0.03495,0.03838,0.04215,0.04629,0.05083,0.05581,0.06127,0.06726,0.07384,0.08105,0.08895,0.09761,0.10709,0.11746,0.12881,0.14121,0.15475,0.16951,0.18558,0.20304,0.22197,0.24245,0.26457,0.2884,0.31399,0.34138,0.37062,0.4017,0.43462,0.46933,0.50577,1.0];
        const CONST_EX_FEMALE = [87.13,86.28,85.31,84.32,83.33,82.34,81.35,80.36,79.36,78.37,77.37,76.38,75.38,74.39,73.39,72.41,71.42,70.43,69.45,68.46,67.48,66.50,65.52,64.54,63.56,62.58,61.59,60.61,59.63,58.65,57.67,56.68,55.70,54.72,53.74,52.76,51.78,50.80,49.82,48.85,47.88,46.90,45.93,44.96,43.99,43.03,42.06,41.10,40.15,39.19,38.24,37.30,36.35,35.41,34.48,33.54,32.61,31.69,30.76,29.84,28.92,28.00,27.09,26.18,25.28,24.38,23.49,22.60,21.72,20.84,19.97,19.11,18.25,17.41,16.58,15.75,14.94,14.14,13.35,12.58,11.83,11.09,10.38,9.69,9.01,8.37,7.75,7.15,6.59,6.05,5.55,5.08,4.65,4.24,3.84,3.47,3.14,2.84,2.56,2.31,2.08,1.88,1.69,1.52,1.37,1.23];

        // --- HEALTH ENGINE SERVICE ---
        const simulate = (startAge, sex, hr) => {
            const qx_data = (sex === 'male') ? CONST_QX_MALE : CONST_QX_FEMALE;
            let lx = 1.0;
            let le = 0.0;
            const curve = [];
            const safeStartAge = Math.min(startAge, qx_data.length - 1);
            for (let t = safeStartAge; t < 115; t++) {
                let q_base = (t < qx_data.length) ? qx_data[t] : 1.0;
                let q_adj = 1 - Math.pow((1 - q_base), hr);
                if (q_adj > 1.0) q_adj = 1.0;
                const lx_next = lx * (1 - q_adj);
                le += (lx + lx_next) / 2.0;
                curve.push(lx);
                lx = lx_next;
                if (lx < 0.0001) break;
            }
            return { le, curve };
        };

        const calculateExpectedEarnings = (age, curve) => {
            let totalExpectedEarnings = 0;
            const yearsToWork = Math.max(0, RETIREMENT_AGE - age);
            for (let i = 0; i < yearsToWork; i++) {
                const probAlive = curve[i] || 0;
                totalExpectedEarnings += probAlive * (HOURLY_WAGE * ANNUAL_HOURS);
            }
            return totalExpectedEarnings;
        };

        const runHealthAnalysis = (data) => {
            const { age, sex, height, weight } = data;
            const ex_table = (sex === 'male') ? CONST_EX_MALE : CONST_EX_FEMALE;
            const official_ex = (age < ex_table.length) ? ex_table[age] : 0;
            let factors = [];
            let hr_total = 1.0;

            if (height > 0 && weight > 0) {
                const bmi = weight / Math.pow(height / 100, 2);
                if (bmi < 18.5) factors.push({ label: "低体重", hr: 1.6 });
                else if (bmi >= 30) factors.push({ label: "肥満(重)", hr: 1.3 });
                else if (bmi >= 25) factors.push({ label: "肥満(軽)", hr: 1.1 });
            }
            if (data.alcohol === 'moderate') factors.push({ label: "適度飲酒(Bonus)", hr: 0.9 });
            else if (data.alcohol === 'heavy') factors.push({ label: "多量飲酒", hr: 1.4 });
            if (data.smoking === 'never') factors.push({ label: "非喫煙(Bonus)", hr: 0.85 });
            else if (data.smoking === 'past') factors.push({ label: "過去喫煙", hr: 1.1 });
            else factors.push({ label: "現在喫煙", hr: 1.6 });
            if (data.exercise === 'yes') factors.push({ label: "運動習慣(Bonus)", hr: 0.85 });
            else factors.push({ label: "運動不足", hr: 1.1 });
            if (data.polypharmacy === '1-4') factors.push({ label: "内服薬あり", hr: 1.1 });
            else if (data.polypharmacy === '5+') factors.push({ label: "多剤併用", hr: 1.3 });
            if (data.pylori === 'negative') factors.push({ label: "ピロリ未感染(Bonus)", hr: 0.98 });
            else if (data.pylori === 'current') factors.push({ label: "ピロリ現感染", hr: 1.28 });
            else if (data.pylori === 'eradicated') factors.push({ label: "ピロリ除菌済(Bonus)", hr: 1.05 });
            if (data.fam_cancer) factors.push({ label: "がん家族歴", hr: 1.1 });
            if (data.parent_long) factors.push({ label: "親が長寿(Bonus)", hr: 0.85 });
            if (data.allergy) factors.push({ label: "アレルギー体質", hr: 1.0 });
            if (data.hist_cancer) factors.push({ label: "がん既往", hr: 1.4 });
            if (data.hist_stroke) factors.push({ label: "脳卒中既往", hr: 2.0 });
            if (data.hist_heart) factors.push({ label: "心疾患既往", hr: 1.8 });
            if (data.dm) factors.push({ label: "糖尿病", hr: 1.3 });
            if (data.htn) factors.push({ label: "高血圧", hr: 1.2 });
            if (data.dl) factors.push({ label: "高脂血症", hr: 1.1 });
            if (data.inf_hep) factors.push({ label: "肝炎ウイルス", hr: 1.2 });
            if (data.inf_hpv) factors.push({ label: "HPV", hr: 1.05 });

            factors.forEach(f => hr_total *= f.hr);
            hr_total = Math.max(hr_total, 0.3);

            const sim_base = simulate(age, sex, 1.0);
            const bias = official_ex - sim_base.le;
            const sim_user = simulate(age, sex, hr_total);
            const final_le = Math.max(0.1, sim_user.le + bias);
            const diff = final_le - official_ex;

            let median_age = age + final_le;
            if (sim_user.curve && sim_user.curve.length > 0) {
                for (let i = 0; i < sim_user.curve.length; i++) {
                    if (sim_user.curve[i] <= 0.5) {
                        const prev = i > 0 ? sim_user.curve[i - 1] : 1.0;
                        const curr = sim_user.curve[i];
                        const frac = (prev - 0.5) / (prev - curr);
                        median_age = (age + i - 1) + frac;
                        break;
                    }
                }
            }

            let hr_ideal = 1.0;
            const immutable_factors = ['がん家族歴', '親が長寿(Bonus)', 'がん既往', '脳卒中既往', '心疾患既往', '糖尿病', '高血圧', '高脂血症', 'アレルギー体質'];
            factors.forEach(f => {
                if (immutable_factors.includes(f.label)) hr_ideal *= f.hr;
                else if (f.label.includes("Bonus")) hr_ideal *= f.hr;
            });
            if (data.smoking !== 'never') hr_ideal *= 0.85; 
            if (data.exercise !== 'yes') hr_ideal *= 0.85; 
            if (data.alcohol === 'heavy') hr_ideal *= 0.9;
            
            const sim_ideal = simulate(age, sex, hr_ideal);
            const earningsCurrent = calculateExpectedEarnings(age, sim_user.curve);
            const earningsAvg = calculateExpectedEarnings(age, sim_base.curve);
            const earningsIdeal = calculateExpectedEarnings(age, sim_ideal.curve);

            const currentLoss = Math.max(0, earningsAvg - earningsCurrent);
            const potentialGain = Math.max(0, earningsIdeal - earningsCurrent);

            const chartData = sim_user.curve.map((prob, i) => ({
                age: age + i,
                survival: prob,
                avgSurvival: sim_base.curve[i] || 0
            })).filter((_, i) => (age + i) <= 105);

            const factorImpacts = factors.map(f => {
                const sim_f = simulate(age, sex, f.hr);
                return {
                    label: f.label,
                    hr: f.hr,
                    impact: (sim_f.le + bias) - official_ex
                };
            }).sort((a, b) => b.impact - a.impact);

            return {
                le: parseFloat(final_le.toFixed(2)),
                lifespan: parseFloat((age + final_le).toFixed(1)),
                median: parseFloat(median_age.toFixed(1)),
                diff: parseFloat(diff.toFixed(2)),
                official: parseFloat(official_ex.toFixed(2)),
                curve: chartData,
                economic: { currentLoss, potentialGain },
                factors: factorImpacts
            };
        };

        // --- COMPONENTS ---
        const InputForm = ({ data, onChange, onAnalyze }) => {
            const handleChange = (key, value) => onChange({ ...data, [key]: value });
            const getBMI = () => (data.height > 0 && data.weight > 0) ? (data.weight / Math.pow(data.height / 100, 2)).toFixed(1) : "--";
            const bmi = parseFloat(getBMI());
            let bmiColor = "text-slate-500", bmiLabel = "";
            if (bmi < 18.5) { bmiColor = "text-red-500"; bmiLabel = "(低体重)"; }
            else if (bmi < 25) { bmiColor = "text-green-500"; bmiLabel = "(標準)"; }
            else if (bmi < 30) { bmiColor = "text-yellow-600"; bmiLabel = "(肥満 1度)"; }
            else if (!isNaN(bmi)) { bmiColor = "text-red-600"; bmiLabel = "(肥満 2度以上)"; }

            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 border-b pb-3">
                            <User className="w-5 h-5 text-accent" /> 基本プロフィール
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-semibold text-slate-600 mb-1">年齢</label>
                                <select className="w-full p-3 border border-slate-300 rounded-lg bg-white" value={data.age} onChange={(e) => handleChange('age', parseInt(e.target.value))}>
                                    {Array.from({ length: 81 }, (_, i) => i + 20).map(age => <option key={age} value={age}>{age} 歳</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-slate-600 mb-1">性別</label>
                                <select className="w-full p-3 border border-slate-300 rounded-lg bg-white" value={data.sex} onChange={(e) => handleChange('sex', e.target.value)}>
                                    <option value="male">男性</option>
                                    <option value="female">女性</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-slate-600 mb-1">身長 (cm)</label>
                                <input type="number" className="w-full p-3 border border-slate-300 rounded-lg" value={data.height} onChange={(e) => handleChange('height', parseFloat(e.target.value) || 0)} />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-slate-600 mb-1">体重 (kg)</label>
                                <input type="number" className="w-full p-3 border border-slate-300 rounded-lg" value={data.weight} onChange={(e) => handleChange('weight', parseFloat(e.target.value) || 0)} />
                            </div>
                        </div>
                        <div className="text-right mt-3 text-sm">BMI: <span className={`font-bold text-lg ${bmiColor}`}>{getBMI()}</span> <span className={bmiColor}>{bmiLabel}</span></div>
                    </div>

                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 border-b pb-3"><Activity className="w-5 h-5 text-accent" /> 生活習慣・家族歴</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label className="block text-sm font-semibold text-slate-600 mb-1">飲酒習慣</label>
                                <select className="w-full p-3 border border-slate-300 rounded-lg bg-white" value={data.alcohol} onChange={(e) => handleChange('alcohol', e.target.value)}>
                                    <option value="none">飲まない</option>
                                    <option value="moderate">適度</option>
                                    <option value="heavy">多量</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-slate-600 mb-1">喫煙歴</label>
                                <select className="w-full p-3 border border-slate-300 rounded-lg bg-white" value={data.smoking} onChange={(e) => handleChange('smoking', e.target.value)}>
                                    <option value="never">吸わない</option>
                                    <option value="past">過去</option>
                                    <option value="current">現在</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-slate-600 mb-1">運動習慣</label>
                                <select className="w-full p-3 border border-slate-300 rounded-lg bg-white" value={data.exercise} onChange={(e) => handleChange('exercise', e.target.value)}>
                                    <option value="yes">あり</option>
                                    <option value="no">なし</option>
                                </select>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <label className="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><input type="checkbox" className="w-5 h-5 text-accent mr-3" checked={data.fam_cancer} onChange={(e) => handleChange('fam_cancer', e.target.checked)} />がん家族歴</label>
                            <label className="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><input type="checkbox" className="w-5 h-5 text-accent mr-3" checked={data.parent_long} onChange={(e) => handleChange('parent_long', e.target.checked)} />親が長寿</label>
                            <label className="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><input type="checkbox" className="w-5 h-5 text-accent mr-3" checked={data.allergy} onChange={(e) => handleChange('allergy', e.target.checked)} />アレルギー</label>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 border-b pb-3"><FileText className="w-5 h-5 text-accent" /> 既往歴・感染症</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label className="block text-sm font-semibold text-red-500 mb-1">ピロリ菌検査</label>
                                <select className="w-full p-3 border border-slate-300 rounded-lg bg-white" value={data.pylori} onChange={(e) => handleChange('pylori', e.target.value)}>
                                    <option value="unknown">不明</option>
                                    <option value="negative">陰性</option>
                                    <option value="eradicated">除菌済</option>
                                    <option value="current">陽性</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-slate-600 mb-1">内服薬</label>
                                <select className="w-full p-3 border border-slate-300 rounded-lg bg-white" value={data.polypharmacy} onChange={(e) => handleChange('polypharmacy', e.target.value)}>
                                    <option value="0">なし</option>
                                    <option value="1-4">1-4種</option>
                                    <option value="5+">5種以上</option>
                                </select>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            {[{k:'hist_cancer',l:'がん既往',w:true},{k:'hist_stroke',l:'脳卒中',w:true},{k:'hist_heart',l:'心筋梗塞',w:true},{k:'dm',l:'糖尿病'},{k:'htn',l:'高血圧'},{k:'dl',l:'高脂血症'},{k:'inf_hep',l:'肝炎'},{k:'inf_hpv',l:'HPV'}].map((i) => (
                                <label key={i.k} className={`flex items-center p-3 border rounded-lg cursor-pointer ${i.w?'bg-red-50 border-red-200 hover:bg-red-100':'bg-white hover:bg-slate-50'}`}><input type="checkbox" className="w-4 h-4 text-accent mr-2" checked={data[i.k]} onChange={(e) => handleChange(i.k, e.target.checked)} /><span className="text-sm">{i.l}</span></label>
                            ))}
                        </div>
                    </div>
                    <button onClick={onAnalyze} className="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 text-white text-xl font-bold rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2"><Calculator className="w-6 h-6" /> 分析する</button>
                </div>
            );
        };

        const Dashboard = ({ result, userData }) => {
            const formatMoney = (val) => `¥${Math.floor(val).toLocaleString()}`;
            const shareLine = () => { window.open("https://line.me/R/share?text=" + encodeURIComponent(`【Precision Health】\n推定余命: ${result.le}年\n平均差: ${result.diff>=0?'+':''}${result.diff}年`), '_blank'); };
            const copyResult = () => { navigator.clipboard.writeText(`推定余命: ${result.le}年 (平均差: ${result.diff}年)`).then(() => alert("コピーしました")); };
            
            const downloadReport = () => {
                const dSign = result.diff >= 0 ? "+" : "";
                const dateStr = new Date().toLocaleDateString("ja-JP");
                const bmi = (userData.weight / Math.pow(userData.height / 100, 2)).toFixed(1);
                const reportContent = `
============================================
Precision Health Manager レポート
発行日: ${dateStr}
============================================
[基本情報]
年齢: ${userData.age}歳 / 性別: ${userData.sex === 'male' ? '男性' : '女性'}
BMI: ${bmi}

[分析結果]
推定余命: ${result.le} 年 (寿命: ${result.lifespan} 歳)
平均差: ${dSign}${result.diff} 年

[経済的価値]
損失: ${result.economic.currentLoss === 0 ? 'なし' : '-' + formatMoney(result.economic.currentLoss)}
改善余地: ${result.economic.potentialGain === 0 ? 'なし' : '+' + formatMoney(result.economic.potentialGain)}

[詳細]
${result.factors.map(f => `・${f.label}: x${f.hr}`).join('\n')}
============================================`;
                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Report_${dateStr.replace(/\//g, '-')}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            useEffect(() => { document.getElementById('dash')?.scrollIntoView({ behavior: 'smooth' }); }, [result]);

            return (
                <div id="dash" className="space-y-6 animate-fade-in">
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 flex gap-4 items-start">
                        <div className="bg-blue-200 p-3 rounded-full shrink-0"><HeartPulse className="w-8 h-8 text-blue-600" /></div>
                        <div>
                            <h4 className="font-bold text-blue-700 mb-2">AIコーチ</h4>
                            <div className="text-slate-700">{result.economic.potentialGain>0 ? `あと${formatMoney(result.economic.potentialGain)}分の健康価値を取り戻せます！禁煙・運動から始めましょう。` : `素晴らしい管理です！この調子で維持しましょう。`}</div>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"><div className="text-sm text-slate-500">推定余命</div><div className="text-4xl font-extrabold text-slate-800">{result.le} <span className="text-lg">年</span></div></div>
                        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"><div className="text-sm text-slate-500">推定寿命</div><div className="text-4xl font-extrabold text-slate-800">{result.lifespan} <span className="text-lg">歳</span></div></div>
                        <div className={`p-6 rounded-2xl border ${result.diff>=0?'bg-green-50 border-green-200':'bg-red-50 border-red-200'}`}><div className="text-sm text-slate-500">平均差</div><div className={`text-4xl font-extrabold ${result.diff>=0?'text-green-600':'text-red-600'}`}>{result.diff>=0?'+':''}{result.diff} <span className="text-lg">年</span></div></div>
                    </div>
                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                        <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><DollarSign className="w-5 h-5" /> 経済的インパクト</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className={`p-5 rounded-xl border ${result.economic.currentLoss===0?'bg-green-50 border-green-200':'bg-red-50 border-red-200'}`}><div className="font-bold text-sm">現在の損失期待値</div><div className={`text-3xl font-extrabold ${result.economic.currentLoss===0?'text-green-600':'text-red-600'}`}>{result.economic.currentLoss===0?'¥0':`-${formatMoney(result.economic.currentLoss)}`}</div></div>
                            <div className="bg-blue-50 border border-blue-200 p-5 rounded-xl"><div className="font-bold text-blue-800 text-sm">改善ポテンシャル</div><div className="text-3xl font-extrabold text-blue-600">+{formatMoney(result.economic.potentialGain)}</div></div>
                        </div>
                    </div>
                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 h-[400px]">
                        <ResponsiveContainer width="100%" height="100%">
                            <LineChart data={result.curve}>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                <XAxis dataKey="age" />
                                <YAxis domain={[0,1]} />
                                <Tooltip formatter={(v)=>`${(v*100).toFixed(1)}%`}/>
                                <Legend />
                                <Line type="monotone" dataKey="survival" stroke="#2563eb" strokeWidth={3} dot={false} name="あなた" />
                                <Line type="monotone" dataKey="avgSurvival" stroke="#94a3b8" strokeDasharray="5 5" dot={false} name="平均" />
                            </LineChart>
                        </ResponsiveContainer>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button onClick={shareLine} className="flex items-center justify-center gap-2 p-4 bg-[#06c755] text-white font-bold rounded-xl shadow hover:bg-[#05b34c]"><Share2 className="w-5 h-5" /> LINE</button>
                        <button onClick={downloadReport} className="flex items-center justify-center gap-2 p-4 bg-blue-600 text-white font-bold rounded-xl shadow hover:bg-blue-700"><Download className="w-5 h-5" /> レポート保存</button>
                        <button onClick={copyResult} className="flex items-center justify-center gap-2 p-4 bg-slate-700 text-white font-bold rounded-xl shadow hover:bg-slate-800"><Copy className="w-5 h-5" /> コピー</button>
                    </div>
                </div>
            );
        };

        const SymptomChecker = () => {
            const [active, setActive] = useState([]);
            const toggle = (id) => setActive(prev => prev.includes(id) ? prev.filter(x=>x!==id) : [...prev,id]);
            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><Thermometer className="w-6 h-6 text-accent"/> 症状チェック</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                            {[{id:'fever',l:'発熱'},{id:'pain',l:'疼痛'},{id:'stomach',l:'消化器'},{id:'injury',l:'外傷'}].map(s=>(
                                <button key={s.id} onClick={()=>toggle(s.id)} className={`p-4 rounded-xl border font-bold ${active.includes(s.id)?'bg-blue-50 border-blue-500 text-blue-700':'bg-white text-slate-600'}`}>{s.l}</button>
                            ))}
                        </div>
                        <div className="space-y-4">
                            {active.includes('fever') && <div className="border p-4 rounded-xl animate-slide-down"><div className="font-bold mb-2">発熱・感冒</div><div className="text-sm">⚠️ 38℃以上が4日続く、意識障害がある場合は受診してください。水分摂取が可能な場合はセルフケア可能です。</div></div>}
                            {active.includes('pain') && <div className="border p-4 rounded-xl animate-slide-down"><div className="font-bold mb-2">疼痛</div><div className="text-sm">⚠️ 安静時も痛む、麻痺がある場合は受診してください。</div></div>}
                            {active.includes('stomach') && <div className="border p-4 rounded-xl animate-slide-down"><div className="font-bold mb-2">消化器</div><div className="text-sm">⚠️ 激しい腹痛、血便がある場合は受診してください。</div></div>}
                            {active.includes('injury') && <div className="border p-4 rounded-xl animate-slide-down"><div className="font-bold mb-2">外傷</div><div className="text-sm">⚠️ 止血困難、深い傷は受診してください。</div></div>}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [tab, setTab] = useState('input');
            const [data, setData] = useState({age:40,sex:'male',height:170,weight:65,alcohol:'none',smoking:'never',exercise:'no',pylori:'unknown',polypharmacy:'0',fam_cancer:false,parent_long:false,allergy:false,hist_cancer:false,hist_stroke:false,hist_heart:false,dm:false,htn:false,dl:false,inf_hep:false,inf_hpv:false});
            const [res, setRes] = useState(null);
            return (
                <div className="flex min-h-screen bg-bg text-primary font-sans">
                    <aside className="hidden md:flex flex-col w-64 bg-slate-900 text-white fixed h-full z-20">
                        <div className="p-6 flex items-center gap-3 text-xl font-bold text-blue-400"><Heart className="w-6 h-6" /> Precision Health</div>
                        <nav className="flex-1 px-4 space-y-2">
                            <button onClick={()=>setTab('input')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl ${tab==='input'?'bg-slate-700':'hover:bg-slate-800'}`}><Edit3 className="w-5 h-5"/> 入力・分析</button>
                            <button onClick={()=>setTab('symptom')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl ${tab==='symptom'?'bg-slate-700':'hover:bg-slate-800'}`}><Stethoscope className="w-5 h-5"/> 症状チェック</button>
                        </nav>
                    </aside>
                    <main className="flex-1 md:ml-64 p-4 md:p-8">
                        <header className="mb-8 md:hidden text-center font-bold text-xl">Precision Health Mobile</header>
                        <div className="md:hidden flex mb-6 bg-white p-1 rounded-xl border"><button onClick={()=>setTab('input')} className={`flex-1 py-2 rounded-lg font-bold ${tab==='input'?'bg-blue-600 text-white':''}`}>分析</button><button onClick={()=>setTab('symptom')} className={`flex-1 py-2 rounded-lg font-bold ${tab==='symptom'?'bg-blue-600 text-white':''}`}>症状</button></div>
                        <div className="max-w-4xl mx-auto">
                            {tab==='input' ? (
                                <div className="space-y-8">
                                    <InputForm data={data} onChange={setData} onAnalyze={()=>setRes(runHealthAnalysis(data))} />
                                    {res && <Dashboard result={res} userData={data} />}
                                </div>
                            ) : <SymptomChecker />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>